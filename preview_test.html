<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .main-container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .section-header {
      background-color: #007bff;
      color: white;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 25px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .timer-container {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }
    .timer-progress {
      height: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      margin-top: 10px;
    }
    .timer-progress-bar {
      height: 100%;
      border-radius: 5px;
      transition: width 1s linear;
    }
    .question-container {
      margin-bottom: 25px;
      padding: 20px;
      border: 1px solid #eee;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    .question-number {
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
      text-align: center;
      font-size: 1.2em;
      padding: 8px 0;
      border-bottom: 2px solid #007bff;
      margin-bottom: 20px;
    }
    .question-text {
      margin-top: 20px;
      margin-bottom: 15px;
      text-align: justify;
      padding: 0 10px;
      line-height: 1.6;
    }
    .question-image-container {
      text-align: center;
      margin: 15px 0;
      width: 100%;
    }
    .question-image {
      max-width: 100%;
      max-height: 300px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: block;
      margin: 0 auto;
    }
    .options-container {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
      margin-top: 20px;
    }
    .option {
      direction: ltr;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      text-align: left;
      border: 2px solid #007bff;
      border-radius: 8px;
      padding: 10px 15px;
      background-color: white;
      width: 100%;
      transition: background 0.2s ease, border 0.2s ease;
      position: relative;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .option:hover {
      background-color: #f1f9ff;
    }
    .option.selected {
      background-color: #d6ebff;
      border-color: #0056b3;
    }
    .option-radio {
      margin-right: 12px;
      flex-shrink: 0;
    }
    .option-content {
        display: flex;
        align-items: center;
        flex-grow: 1;
  /* اتجاه العناصر من اليسار لليمين */
        flex-direction: row;
    }

    .option-letter {

      font-weight: bold;
      color: #007bff;
      min-width: 20px;
      margin-right: 10px;
      flex-shrink: 0;
    }
    .option-text {
      flex-grow: 1;
      text-align: left;
      order: 1
    }
    option-image-container {
  /* الصورة تظهر على أقصى اليسار */
        order: -1; /* هذا يجعل الصورة أول عنصر */
        margin-right: 10px; /* مسافة بين الصورة والحرف */
        margin-left: 0;
        flex-shrink: 0;
    }
    .option-image {
      max-width: 150px;
      max-height: 100px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .btn-navigation {
      padding: 10px 25px;
      font-weight: bold;
    }
    .hidden {
      display: none;
    }
    .section-transition {
      text-align: center;
      padding: 30px;
      font-size: 18px;
      color: #555;
    }
    .MathJax {
      outline: none;
    }
    .gridin-container {
      margin-top: 20px;
      text-align: center;
    }
    .gridin-input-container {
      display: inline-block;
      position: relative;
      margin: 15px 0;
    }
    .gridin-input {
      width: 200px;
      height: 50px;
      font-size: 18px;
      text-align: center;
      border: 2px solid #007bff;
      border-radius: 5px;
      padding: 5px;
    }
    .gridin-underline {
      position: absolute;
      bottom: 8px;
      left: 5px;
      right: 5px;
      height: 2px;
      background-color: #333;
    }
    .no-options-message {
      color: #666;
      font-style: italic;
      text-align: center;
      margin: 20px 0;
    }
    .results-container {
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
    }
    .bg-success-light {
      background-color: #e8f5e9;
      border-left: 4px solid #4caf50;
    }
    .bg-danger-light {
      background-color: #ffebee;
      border-left: 4px solid #f44336;
    }
    .question-result {
      border-radius: 5px;
      margin-bottom: 15px;
      padding: 15px;
    }
    .question-result .question-image-container {
      text-align: center;
      margin: 15px 0;
    }
    .question-result .question-image {
      max-width: 100%;
      max-height: 250px;
      border-radius: 8px;
      margin: 0 auto;
      display: block;
    }
    .question-result-text {
      margin-top: 15px;
    }
    .explanation {
      padding: 10px;
      background-color: #fff;
      border-radius: 4px;
      border: 1px solid #ddd;
      margin-top: 10px;
    }
    .score-display {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
      text-align: center;
      margin: 20px 0;
    }
    .alert-danger {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
      padding: 15px;
      border-radius: 5px;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div id="sectionHeader" class="section-header">Loading Test...</div>
    
    <div class="timer-container" id="timerContainer">
      <h3>Time Remaining: <span id="timerDisplay">00:00</span></h3>
      <div class="timer-progress">
        <div class="timer-progress-bar" id="timerBar"></div>
      </div>
    </div>

    <div id="testContent">
      <!-- Content will be filled here -->
    </div>

    <div class="navigation-buttons" id="navigationButtons">
      <button id="prevBtn" class="btn btn-secondary btn-navigation" disabled>Previous</button>
      <span id="questionCounter">Question 0 of 0</span>
      <button id="nextBtn" class="btn btn-primary btn-navigation">Next</button>
      <button id="submitSectionBtn" class="btn btn-warning btn-navigation hidden">Submit Section</button>
    </div>
  </div>

  <script>
    // MathJax Configuration
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      options: {
        enableMenu: false,
        ignoreHtmlClass: 'tex2jax_ignore',
        processHtmlClass: 'tex2jax_process'
      }
    };

    // Global Variables
    let testData = {
      TestTitle: "",
      sections: []
    };
    let currentSectionIndex = 0;
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let timerInterval;
    let sectionTimeLeft = 0;
    let isTransitioning = false;

    // Initialize Test
    async function initializeTest() {
      try {
        const testID = new URLSearchParams(window.location.search).get('testID');
        if (!testID) throw new Error('Test ID not provided');

        const response = await fetch(`get_full_test.php?testID=${testID}`);
        if (!response.ok) throw new Error('Failed to load test data');

        const data = await response.json();
        console.log("✅ FULL testData received:", data);
        testData = data;

        if (!data || !data.sections || !Array.isArray(data.sections)) {
          throw new Error('Invalid test data structure');
        }

        // Process received data
        testData.TestTitle = data.TestTitle || "Untitled Test";
        testData.sections = data.sections.map(section => ({
          SectionID: section.SectionID,
          SectionTitle: section.SectionTitle || `Section ${section.SectionNumber}`,
          duration: parseInt(section.Duration) || 30,
          questions: section.questions.map(question => ({
            QuestionID: question.questionID,
            QuestionText: question.QuestionText,
            QuestionImage: question.QuestionImage,
            QuestionType: question.QuestionType,
            AnswerOptions: question.AnswerOptions ? question.AnswerOptions.map(option => ({
              optionText: option.optionText,
              optionImage: option.optionImage,
              isCorrect: option.isCorrect === "1" || option.isCorrect === 1
            })) : []
          }))
        }));

        // Initialize answers array
        userAnswers = [];
        testData.sections.forEach(section => {
          section.questions.forEach(() => {
            userAnswers.push(null);
          });
        });

        // Start first section
        startCurrentSection();
        
      } catch (error) {
        console.error('Error initializing test:', error);
        showError(`Error loading test: ${error.message}`);
      }
    }

    // Show error message
    function showError(message) {
      document.getElementById('testContent').innerHTML = `
        <div class="alert alert-danger">
          ${message}
          <button onclick="location.reload()" class="btn btn-sm btn-warning mt-2">Try Again</button>
        </div>
      `;
      document.getElementById('timerContainer').classList.add('hidden');
      document.getElementById('navigationButtons').classList.add('hidden');
    }

    // Start current section
    function startCurrentSection() {
      const section = testData.sections[currentSectionIndex];
      document.getElementById('sectionHeader').textContent = 
        `${testData.TestTitle} - ${section.SectionTitle}`;
      
      sectionTimeLeft = section.duration * 60;
      updateTimerDisplay();
      startTimer();
      displayCurrentQuestion();
    }

    // Display current question
    function displayCurrentQuestion() {
      if (isTransitioning) return;
      
      const section = testData.sections[currentSectionIndex];
      const question = section.questions[currentQuestionIndex];
      const globalIndex = getGlobalQuestionIndex();
      
      let html = `
        <div class="question-container">
          <div class="question-number">Question ${currentQuestionIndex + 1} of ${section.questions.length}</div>
      `;

      // Add question image at the top if exists
      if (question.QuestionImage) {
        html += `
          <div class="question-image-container">
            <img src="/Project_1_New/${question.QuestionImage}" class="question-image" 
                 alt="Question Image" onerror="this.style.display='none'">
          </div>
        `;
      }

      // Add question text
      html += `
        <div class="question-text">${question.QuestionText || ''}</div>
        <div class="options-container">
      `;

      if (question.QuestionType.toLowerCase() === 'grid-in') {
        html += `
          <div class="gridin-container">
            <div class="gridin-input-container">
              <input type="text" class="gridin-input" id="gridin-${globalIndex}" 
                     value="${userAnswers[globalIndex] || ''}"
                     oninput="validateGridinInput(this)">
              <div class="gridin-underline"></div>
            </div>
          </div>
        `;
      } else {
        question.AnswerOptions.forEach((option, i) => {
          html += `
            <label class="option">
              <input type="radio" name="q${globalIndex}" value="${i}" class="option-radio" 
                     ${userAnswers[globalIndex] === i ? 'checked' : ''}>
              <div class="option-content">
                <span class="option-letter">${String.fromCharCode(65 + i)}.</span>
                <div class="option-text">${option.optionText}</div>
          `;
          if (option.optionImage) {
            html += `<div class="option-image-container">
                      <img src="/Project_1_New/${option.optionImage}" class="option-image">
                    </div>`;
          }
          html += `</div></label>`;
        });
      }

      html += `</div></div>`;
      document.getElementById('testContent').innerHTML = html;
      document.getElementById('questionCounter').textContent = 
        `Question ${currentQuestionIndex + 1} of ${section.questions.length}`;
      
      updateNavigationButtons();
      setupOptionSelection();
      
      if (question.QuestionType.toLowerCase() === 'grid-in') {
        document.getElementById(`gridin-${globalIndex}`).addEventListener('input', function() {
          validateGridinInput(this);
        });
      } else {
        document.querySelectorAll('.option-radio').forEach(radio => {
          radio.addEventListener('change', function() {
            userAnswers[globalIndex] = parseInt(this.value);
          });
        });
      }

      if (window.MathJax) MathJax.typesetPromise();
    }

    // Validate Grid-in input
    function validateGridinInput(input) {
      input.value = input.value.replace(/[^0-9.]/g, '');
      if ((input.value.match(/\./g) || []).length > 1) {
        input.value = input.value.slice(0, -1);
      }
      const index = parseInt(input.id.split('-')[1]);
      userAnswers[index] = input.value;
    }

    // Navigation functions
    function goToNextQuestion() {
      const section = testData.sections[currentSectionIndex];
      if (currentQuestionIndex < section.questions.length - 1) {
        currentQuestionIndex++;
        displayCurrentQuestion();
      }
    }

    function goToPrevQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayCurrentQuestion();
      }
    }

    // Submit current section
    function submitCurrentSection() {
      clearInterval(timerInterval);
      if (currentSectionIndex < testData.sections.length - 1) {
        showSectionTransition();
      } else {
        submitEntireTest();
      }
    }

    function showSectionTransition() {
      isTransitioning = true;

      const breakSeconds = testData.BreakDuration ? parseInt(testData.BreakDuration) * 60 : 5;
      console.log("✅ BreakDuration =", testData.BreakDuration, "→", breakSeconds, "seconds");

      document.querySelector('.test-header')?.classList.add('hidden');
      document.querySelector('.timer-container')?.classList.add('hidden');
      document.getElementById('navigationButtons')?.classList.add('hidden');
      document.querySelector('.section-header')?.classList.add('hidden');

      document.getElementById('testContent').innerHTML = `
        <div class="section-transition">
          <h3>Section Completed</h3>
          <p>Preparing next section in <span id="breakCountdown">${breakSeconds}</span> seconds...</p>
        </div>
      `;

      let secondsLeft = breakSeconds;
      const countdownInterval = setInterval(() => {
        secondsLeft--;
        const countdownEl = document.getElementById('breakCountdown');
        if (countdownEl) {
          countdownEl.textContent = secondsLeft;
        }
        if (secondsLeft <= 0) {
          clearInterval(countdownInterval);
        }
      }, 1000);

      setTimeout(() => {
        currentSectionIndex++;
        currentQuestionIndex = 0;
        isTransitioning = false;
        startCurrentSection();

        document.getElementById('questionNavigation')?.classList.remove('hidden');
        document.getElementById('questionFooter')?.classList.remove('hidden');
        document.getElementById('navigationButtons')?.classList.remove('hidden');
        document.querySelector('.section-header')?.classList.remove('hidden');
      }, breakSeconds * 1000);
    }

    // Submit entire test and grade
    async function submitEntireTest() {
      clearInterval(timerInterval);
      
      try {
        // Calculate results
        let correctAnswersCount = 0;
        let totalQuestions = 0;
        const results = [];
        
        let globalIndex = 0;
        testData.sections.forEach(section => {
          section.questions.forEach(question => {
            totalQuestions++;
            
            let isCorrect = false;
            let correctAnswer = '';
            
            if (question.QuestionType.toLowerCase() === 'grid-in') {
              correctAnswer = question.AnswerOptions[0]?.optionText || '';
              isCorrect = userAnswers[globalIndex] !== null && 
                         Math.abs(parseFloat(userAnswers[globalIndex]) - parseFloat(correctAnswer)) < 0.01;
            } else {
              const correctOptionIndex = question.AnswerOptions.findIndex(opt => opt.isCorrect);
              correctAnswer = question.AnswerOptions[correctOptionIndex]?.optionText || '';
              isCorrect = userAnswers[globalIndex] === correctOptionIndex;
            }
            
            if (isCorrect) correctAnswersCount++;
            
            results.push({
              questionId: question.QuestionID,
              isCorrect: isCorrect,
              correctAnswer: correctAnswer,
              userAnswer: userAnswers[globalIndex] !== null ? userAnswers[globalIndex] : 'No answer'
            });
            
            globalIndex++;
          });
        });
        
        const score = Math.round((correctAnswersCount / totalQuestions) * 100);
        
        // Display results
        showTestResults({
          totalQuestions: totalQuestions,
          correctAnswers: correctAnswersCount,
          score: score,
          details: results
        });
        
      } catch (error) {
        console.error('Error submitting test:', error);
        showError(`Error submitting test: ${error.message}`);
      }
    }

    // Show test results
    function showTestResults(result) {
      let html = `
        <div class="results-container">
          <h3 class="text-center mb-4">Test Results</h3>
          <div class="score-display">
            Your Score: ${result.score}%
          </div>
          <div class="card mb-4">
            <div class="card-body text-center">
              <p>You answered ${result.correctAnswers} out of ${result.totalQuestions} questions correctly</p>
            </div>
          </div>
          <h5 class="mb-3">Detailed Results:</h5>
      `;

      let globalIndex = 0;
      testData.sections.forEach((section, sIndex) => {
        html += `<h6 class="mt-3">${section.SectionTitle}</h6>`;
        
        section.questions.forEach((question, qIndex) => {
          const questionResult = result.details[globalIndex];
          const userAnswer = questionResult.userAnswer;
          let userAnswerDisplay = userAnswer;
          let correctAnswerDisplay = questionResult.correctAnswer;
          
          if (question.QuestionType.toLowerCase() !== 'grid-in' && typeof userAnswer === 'number') {
            userAnswerDisplay = `${String.fromCharCode(65 + userAnswer)}. ${question.AnswerOptions[userAnswer]?.optionText || ''}`;
            correctAnswerDisplay = `${String.fromCharCode(65 + question.AnswerOptions.findIndex(opt => opt.isCorrect))}. ${questionResult.correctAnswer}`;
          }
          
          html += `
            <div class="question-result ${questionResult.isCorrect ? 'bg-success-light' : 'bg-danger-light'}">
              <p><strong>Question ${qIndex + 1}:</strong></p>
              ${question.QuestionImage ? `
                <div class="question-image-container">
                  <img src="/Project_1_New/${question.QuestionImage}" class="question-image">
                </div>
              ` : ''}
              <div class="question-result-text">
                <div class="question-text">${question.QuestionText}</div>
                <p><strong>Your answer:</strong> ${userAnswerDisplay}</p>
                ${!questionResult.isCorrect ? `
                  <p><strong>Correct answer:</strong> ${correctAnswerDisplay}</p>
                ` : ''}
              </div>
            </div>
          `;
          
          globalIndex++;
        });
      });

      html += `</div>`;
      document.getElementById('testContent').innerHTML = html;
      document.getElementById('timerContainer').classList.add('hidden');
      document.getElementById('navigationButtons').classList.add('hidden');
      document.getElementById('sectionHeader').textContent = 'Test Results';
    }

    // Helper functions
    function updateNavigationButtons() {
      const section = testData.sections[currentSectionIndex];
      const prevBtn = document.getElementById('prevBtn');
      
      if (currentQuestionIndex === 0) {
        prevBtn.classList.remove('btn-primary');
        prevBtn.classList.add('btn-secondary');
      } else {
        prevBtn.classList.remove('btn-secondary');
        prevBtn.classList.add('btn-primary');
      }
      
      prevBtn.disabled = currentQuestionIndex === 0;
      const isLastQuestionInSection = currentQuestionIndex === section.questions.length - 1;
      document.getElementById('nextBtn').classList.toggle('hidden', isLastQuestionInSection);
      document.getElementById('submitSectionBtn').classList.toggle('hidden', !isLastQuestionInSection);
    }

    function startTimer() {
      clearInterval(timerInterval);
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        sectionTimeLeft--;
        updateTimerDisplay();
        if (sectionTimeLeft <= 0) {
          clearInterval(timerInterval);
          submitCurrentSection();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(sectionTimeLeft / 60);
      const seconds = sectionTimeLeft % 60;
      document.getElementById('timerDisplay').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      const section = testData.sections[currentSectionIndex];
      const totalSectionTime = section.duration * 60;
      const percentage = (sectionTimeLeft / totalSectionTime) * 100;
      
      const timerBar = document.getElementById('timerBar');
      timerBar.style.width = `${percentage}%`;
      
      if (percentage < 20) {
        timerBar.style.backgroundColor = '#dc3545';
      } else if (percentage < 50) {
        timerBar.style.backgroundColor = '#ffc107';
      } else {
        timerBar.style.backgroundColor = '#28a745';
      }
    }

    function getGlobalQuestionIndex() {
      let index = 0;
      for (let i = 0; i < currentSectionIndex; i++) {
        index += testData.sections[i].questions.length;
      }
      return index + currentQuestionIndex;
    }

    // تظليل الخيار عند النقر
    function setupOptionSelection() {
      document.addEventListener('click', function(e) {
        const option = e.target.closest('.option');
        if (option) {
          document.querySelectorAll('.option').forEach(opt => {
            opt.classList.remove('selected');
          });
          option.classList.add('selected');
        }
      });
    }

    // Event listeners
    document.getElementById('prevBtn').addEventListener('click', goToPrevQuestion);
    document.getElementById('nextBtn').addEventListener('click', goToNextQuestion);
    document.getElementById('submitSectionBtn').addEventListener('click', submitCurrentSection);

    // Initialize test when page loads
    window.addEventListener('DOMContentLoaded', initializeTest);
  </script>
</body>
</html>